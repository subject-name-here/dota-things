# dota-things

The plan:
1) "scrapper.py - парсим dotabuff.com. Матчей с параметром skill_bracket=very_high_skill достаточно много и меньше мусора, по таймингу в 15 минут записываем в текстовый лог match_id. Если снять требования skill_bracket, то тайминг можно снизить до 3-5 минут и увеличить число итераций.  Пример работы в файле match_id.txt" - цитата и scrapper.py принадлежат Ярославу. Еще там в ссылке указано, что мы ищем только матчи 1x1 с героем Shadow Fiend, но при желании это можно менять (скорее всего, придется увеличить время работы, т.к. матчей с другими героями значительно меньше). 

В параметр командной строки можно передать количество часов работы (по умолчанию 1, что слишком мало). Опыт показывает, что 3 часа достаточно.

2) С помощью valvePython/dota2 (https://github.com/ValvePython/dota2) и ранее сгенерированных id формируем ссылки на скачивание реплеев, заодно проверяем реплеи на то, что они нам подходят (нужно, чтобы Shadow Fiend там выиграл). Сохраняем ссылки в файл match_links.txt. 

WARNING: требует id, пароль и код, который приходит на e-mail (код сожно отключить в настройках аккаунта). Вдобавок к этому, можно запрашивать не более 100 ссылок, поэтому просто оставить все это на два дня добывать реплеи не получится.

2.5) Скачиваем архивы по ссылкам из match_links.txt, распаковываем их в папку replays. (Большинство ссылок по какой-то причине невалидны :(, поэтому репеев сильно меньше, чем добытых ранее id.)

Верхние три пункта можно выполнить, запустив script.sh. В параметр можно передать количество часов работы для scrapper.py.

3) Используя clarity, парсим скачанные реплеи: на каждый тик (единица времени в реплее) вытаскиваем состояния (данные об игроке, его противнике, крипах, башне), а также о действиях нашего игрока. Действия отсылаются на локальный сервер на порт 22229 (можно залезть в код и поменять).

4) Сервер в папочке serv. Для того, чтобы он мог работать, нужно в корне создать папку data и дать ей всевозможные права. База данных будет храниться именно там (потому что). После этого вводим последовательно:

python3 manage.py makemigrations
python3 manage.py migrate
python3 manage.py runserver 22229

Он может ругаться, что библиотеки не установлены и т.п. Установите. (вроде, он требует только django)

После этого сервер должен запуститься и радовать.

5) Бот лежит в папочке bot. Его содержимое целиком нужно скопировать в папку с дотой, где должен лежать кастомный бот (что-то вроде ...\steamapps\common\dota 2 beta\game\dota\scripts\vscripts\bots; путь, понятное дело, может варьироваться). После этого запускаете дотку.



Как это работает (в теории): 

1) Вы скачиваете много реплеев (ну, не так много, наверное, 1000 хватит). 

2) Запускаете сервер, запускаете replay_parser. Второй перекидывает первому вагоны данных.

3) Можете катать.

Проблемы (потому что я не хочу issues, их закрывать придется):

1) replay_parser работает очень-очень-очень долго. Ужасно долго. Не 4,5 миллиарда лет, но где-то около того.

2) Максимум способностей бота - дойти до центра и убить пару крипов. (подкрутить k, dist, choose_action?)

3) В теории, можно было бы играть за бота, пока работает replay_parser. Но база данных говорит: "Я не могу, я locked". Иногда она так говорит даже при работе только replay_parser. (найти другую базу данных, которая может в многопоточность?)

4) Общение бота и сервера может работать достаточно долго. (отсечения? магия?)

5) Вся стена этого текста лежит в readme, а не в wiki. 

6) script.sh иногда не работает, как надо.

7) в serv есть какие-то странные файлы с расширением .pyc. 

8) качество кода хромает на три ноги. (ну или мне так кажется)



P.S. Выражаем благодарность karvozavr за предоставленный ноутбук и образец бота. :)
